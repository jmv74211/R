---
title: "titanic"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(funModeling) # Útil para obtener una primera impresión de un dataset.

data_raw <- read_csv('./titanic/train.csv')

#####################    EXPLORACIÓN INICIAL ##################### 

glimpse(data_raw) # Muestra información detallada del dataset.

df_status(data_raw) # Muestra tabla con información adicional sobre los datos

status <- df_status(data_raw)

# Tabla con el recuento de los valores posibles dentro de la columna (histograma)
table(data_raw$Survived)

# Si se quiere con proporciones, utilizamos
prop.table(table(data_raw$Survived))

# Creamos tabla 2D para contar el Número de mujeres y hombres que sobrevivieron y murieron
table(data_raw$Sex,data_raw$Survived) # Recuento
prop.table(table(data_raw$Sex,data_raw$Survived)) # Con porcentajes

# Ahora se va a realizar un modelo simple, diciendo que si es hombre se muere, y si es mujer se sobrevive.

data_test <- read_csv('./titanic/test.csv' )%>%
             mutate(Survived = as.integer(if_else(Sex == 'male',0,1))) %>%
             select(PassengerId, Survived) 

write_csv(data_test,'submission1.csv')

# OPERADORES IMPORTANTES DE DPLYR
# mutate  # Sirve para crear una columna nueva con dplyr
# select # Sirve para seleccionar columnas
# filter # Sirve para seleccionar filas
# summarise # Calcula una determinada operación sobre unos datos y los agrupa
# group_by # Realiza un agrupamiento de los datos. Siempre va con summarise

```


## Correlación

Desde R podemos hacer un procedimiento sencillo para ver la correlación de las variables.

```{r}
# Dibujar gráficos
plotdata <- data_raw %>%
  mutate(Survived = as.factor(Survived))


# Mostramos un histograma de sexo que sobrevive y muere
ggplot(plotdata, aes(x = Sex)) +                   # Aquí ponemos los parámetros comunes a todas las capas, en este caso, el eje x el sexo
  geom_histogram(aes(fill = Survived), stat = "count") # Como la variable no es continua, especifiamos con stat un recuento.


ggplot(plotdata) +                   # Aquí ponemos los parámetros comunes a todas las capas, en este caso, el eje x el sexo
  geom_histogram(aes(x= Age, fill = Survived), bindwidth = 5) # bindwith para agrupar edad de 5 en 5 años

# Gráfica que muestra supervivientes en función del sexo y la clase
ggplot(plotdata) +                   # Aquí ponemos los parámetros comunes a todas las capas, en este caso, el eje x el sexo
  geom_histogram(aes(x= Age, fill = Survived), bindwidth = 3)+     # bindwith para agrupar edad de 5 en 5 años
  facet_wrap(Sex~Pclass)
 

```

## Estudio de correlaciones



```{r}

correlation_table(data_raw,target = "Survived") # Tabla con las columnas todas las variables en filas y columnas, y calcula el valor de correlación

```

En general tenemos que tener bastante cuidado, ya que la correlación solo se calcula sobre variables numéricas. Por lo tanto hay que hacer una recodificación numérica. En este caso tenemos que recodificar el sexo (variable categórica)

```{r}

data_raw_corr <-
  data_raw %>%
  mutate( Sex= ifelse(Sex == 'male',-1.0,1.0))

correlation_table(data_raw_corr, target="Survived")

cor(data_raw_corr$Sex,data_raw_corr$Survived)

## summarise, group_by
## Vamos a ir haciendo combinaciones de agrupaciones para ir obteniendo un mayor detalle

summarise(data_raw,mean(Age))

# Media de las edades
data_raw %>%
  filter(!is.na(Age)) %>%
  summarise(mean(Age))

# Media edades por sexo
data_raw %>%
  filter(!is.na(Age)) %>%
  group_by(Sex) %>%
  summarise(mean(Age))


# Media por sexo y clase
data_raw %>%
  group_by(Sex, Pclass) %>%
  summarise(sum(Survived))
```

Se puede estudiar con más detalle de las mujeres que no sobrevivieron. (Pclass. fair). Se pueden estudiar por rangos de precios, ej <30, [30,50], ... A partir de ahí se puede construir un modelo de predicción. Si es hombre se puede decir que muere, si es mujer ...


# Práctica 1

Es más importante el preprocesamiento que los resultados finales (porcentaje de acierto).
